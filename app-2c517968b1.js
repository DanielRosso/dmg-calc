/*
	Battle.net/Diablo III Tooltip Script

	Changelog:
	v1.1
		- Added support for follower skills
*/
if("undefined"==typeof Bnet)var Bnet={};"undefined"==typeof Bnet.D3&&(Bnet.D3={}),"undefined"==typeof Bnet.D3.Tooltips&&(Bnet.D3.Tooltips=new function(){function e(){B.documentReady(t)}function t(){setTimeout(n,1),setTimeout(o,1)}function n(){var e,t=document.getElementsByTagName("script"),n=t[t.length-1];n&&n.src.match(D)&&(e=RegExp.$1);var o=x.replace("{region}",e||"us");B.getStyle(o+"tooltips.css"),B.Browser.ie6&&B.getStyle(o+"tooltips-ie6.css")}function o(){B.bindEvent(document,"mouseover",function(e){var t=r(e);t&&a(t)}),B.bindEvent(document,"mouseout",function(e){var t=r(e);t&&i(t)})}function r(e){e=B.normalizeEvent(e);for(var t=e.target,n=0;t&&++n<=5;){if("A"==t.nodeName.toUpperCase())return t;t=t.parentNode}return null}function a(e){var t={};if(l(e,t),c(e,t),t.key&&w!=e){w=e,b=t;var n=d(t);null!=n&&p(n)}}function i(e){e==w&&(_.hide(),w=null,b=null)}function l(e,t){if(e.href.match(T))for(var n=RegExp.$1,o=RegExp.$2,r=RegExp.$3,a=0;a<H.length;++a){var i=H[a];if(r.match(i.regex)){var l=RegExp.$1,c=RegExp.$2;if(-1==l.indexOf("/")&&-1==c.indexOf("/")){t.region=n,t.locale=o,t.folder=l,t.key=c;for(var a in i.params)t[a]=i.params[a];return void(t.tooltipType=m(t.type))}}}}function c(e,t){}function u(e){var t=(E+e.tooltipType.url).replace("{region}",e.region).replace("{locale}",e.locale).replace("{folder}",e.folder).replace("{key}",e.key);B.getScript(t+"?format=jsonp")}function s(e){clearTimeout(y);var t=e.params;"item"==t.type&&(t.key=b.key),g(t,e),null!=b&&v(t)==v(b)&&p(e)}function d(e){var t=h(e);return null==t?(clearTimeout(y),y=setTimeout(f,N),u(e),null):t}function f(){null!=w&&_.show(w,'<div class="d3-tooltip"><div class="loading"></div></div>')}function p(e){null!=w&&_.show(w,e.tooltipHtml)}function m(e){return k[e]}function g(e,t){var n=v(e);L[n]=t}function h(e){var t=v(e);return L[t]}function v(e){return[e.region,e.locale,e.type,e.key].join("-")}var y,w,b,x="http://{region}.battle.net/d3/static/css/",E="http://{region}.battle.net/d3/{locale}/tooltip/",k={item:{type:"item",url:"item/{key}"},recipe:{type:"recipe",url:"recipe/{key}"},skill:{type:"skill",url:"skill/{folder}/{key}"},calculator:{type:"calculator",url:"calculator/{folder}/{key}"}},T=new RegExp("^http://([a-z]{2})\\.battle\\.net/d3/([a-z]{2})/(.+)"),D=new RegExp("([a-z]{2})\\.battle\\.net/d3/static/js/tooltips\\.js"),H=[{regex:new RegExp("^item/()([^#\\?]+)$"),params:{type:"item"}},{regex:new RegExp("^artisan/([^/]+)/recipe/([^#\\?]+)$"),params:{type:"recipe"}},{regex:new RegExp("^class/([^/]+)/active/([^#\\?]+)$"),params:{type:"skill"}},{regex:new RegExp("^class/([^/]+)/passive/([^#\\?]+)$"),params:{type:"skill"}},{regex:new RegExp("^follower/([^/]+)/skill/([^#]+)"),params:{type:"skill"}},{regex:new RegExp("^calculator/([^#]+)[#/](.+)"),params:{type:"calculator"}}],N=500,L={};this.registerData=s;var B={create:function(e){return document.createElement(e)},getScript:function(e){var t=B.create("script");t.type="text/javascript",t.src=e,document.body.appendChild(t)},getStyle:function(e){var t=B.create("link");t.rel="stylesheet",t.type="text/css",t.href=e,document.body.appendChild(t)},documentReady:function(e){if("complete"==document.readyState)return void e();var t=!1;B.bindEvent(document,"DOMContentLoaded",function(){t||(t=!0,e())}),B.bindEvent(document,"readystatechange",function(){"complete"!=document.readyState||t||(t=!0,e())})},bindEvent:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!0):e.attachEvent("on"+t,n)},normalizeEvent:function(e){var t={};return t.target=e.target?e.target:e.srcElement,t.which=e.which?e.which:e.button,t},getWindowSize:function(){var e=0,t=0;return document.documentElement&&document.documentElement.clientHeight?(e=document.documentElement.clientWidth,t=document.documentElement.clientHeight):document.body&&document.body.clientHeight?(e=document.body.clientWidth,t=document.body.clientHeight):window.innerHeight&&(e=window.innerWidth,t=window.innerHeight),{w:e,h:t}},getScrollPosition:function(){var e=0,t=0;return window.pageXOffset||window.pageYOffset?(e=window.pageXOffset,t=window.pageYOffset):document.body&&(document.body.scrollLeft||document.body.scrollTop)?(e=document.body.scrollLeft,t=document.body.scrollTop):document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)&&(e=document.documentElement.scrollLeft,t=document.documentElement.scrollTop),{x:e,y:t}},getOffset:function(e){for(var t=0,n=0;e;){t+=e.offsetLeft,n+=e.offsetTop;for(var o=e.parentNode;o&&o!=e.offsetParent&&o.offsetParent;){if(o.scrollLeft||o.scrollTop){t-=0|o.scrollLeft,n-=0|o.scrollTop;break}o=o.parentNode}e=e.offsetParent}return{x:t,y:n}},getViewport:function(){var e=B.getWindowSize(),t=B.getScrollPosition();return{l:t.x,t:t.y,r:t.x+e.w,b:t.y+e.h}}};B.Browser={},B.Browser.ie=!(!window.attachEvent||window.opera),B.Browser.ie6=B.Browser.ie&&-1!=navigator.userAgent.indexOf("MSIE 6.0");var _=new function(){function e(){r=B.create("div"),r.className="d3-tooltip-wrapper",a=B.create("div"),a.className="d3-tooltip-wrapper-inner",r.appendChild(a),document.body.appendChild(r),n()}function t(t,n){null==r&&e(),r.style.visibility="hidden",r.style.display="block",a.innerHTML=n;var l=B.getViewport(),c=B.getOffset(t),u=c.x+t.offsetWidth+i,s=c.y-r.offsetHeight-i;s<l.t&&(s=l.t),u+r.offsetWidth>l.r&&(u=c.x-r.offsetWidth-i),o(u,s)}function n(){null!=r&&(r.style.display="none")}function o(e,t){r.style.left=e+"px",r.style.top=t+"px",r.style.visibility="visible"}var r,a,i=5;this.show=t,this.hide=n};e()}),function(){"use strict";angular.module("d3dps",[])}(),function(){"use strict";function e(){function e(e){var t=e.split(/[#, ,-]/);return t[0]+"-"+t[1]}function t(e){var t="https://eu.api.battle.net/d3/profile/"+e+"/?locale=de_DE&callback=JSON_CALLBACK&apikey=4nzu76bj73zj76uzjgxu6repat4damdy";return t}function n(e,t){var n="http://eu.battle.net/api/d3/profile/"+t+"/hero/"+e+"?callback=JSON_CALLBACK";return n}function o(e){var t="http://eu.battle.net/api/d3/data/"+e+"?callback=JSON_CALLBACK";return t}var r={getUrlForHeroes:t,getUrlForHero:n,getUrlForItem:o,getBattleNetTag:e};return r}angular.module("d3dps").service("urlService",e)}(),function(){"use strict";function e(e,t,n){function o(e,n){return t.all(e.map(r,n))}function r(o){var r=this,l=n.getUrlForHero(o.id,r);return e.jsonp(l).then(function(e){var n=[];return Object.keys(e.data.items).forEach(function(t){var o={};o.slot=t,o.data=e.data.items[t],n.push(o)}),t.all(n.map(a)).then(function(t){var n=e.data;return Object.keys(n.items).forEach(function(e){for(var o=0;o<t.length;o++){var r=t[o];if(e==r.config.item.slot){n.items[e].stats=r.data,t.splice(o,1);break}}}),n.dpsModel=i(n),n})})}function a(t,o){var r=n.getUrlForItem(t.data.tooltipParams);return e.jsonp(r,{item:t})}function i(e){var t={Mainhand:0,Lightning:0,Cold:0,Holy:0,Arcane:0,Fire:0,Poison:0};return l(e,t),c(e,t),t}function l(e,t){var n,o=e.stats.attackSpeed,r=e.stats.critChance,a=e.stats.critDamage;angular.forEach(e.items,function(e,t){"mainHand"==t&&(n=e.stats.dps.min)}),t.Mainhand=n*o*(10*r)*(10*a)}function c(e,t){angular.forEach(e.items,function(e){angular.forEach(e.stats.attributesRaw,function(e,n){0===n.indexOf("Damage_Dealt_Percent_Bonus#Lightning")?t.Lightning+=e.max:0===n.indexOf("Damage_Dealt_Percent_Bonus#Cold")?t.Cold+=e.max:0===n.indexOf("Damage_Dealt_Percent_Bonus#Holy")?t.Holy+=e.max:0===n.indexOf("Damage_Dealt_Percent_Bonus#Arcane")?t.Arcane+=e.max:0===n.indexOf("Damage_Dealt_Percent_Bonus#Fire")?t.Fire+=e.max:0===n.indexOf("Damage_Dealt_Percent_Bonus#Poison")&&(t.Poison+=e.max)})})}function u(e,n){return t.all(e.map(s,n)).then(function(e){return e.every(function(e){return e?!0:!1})})}function s(t){var o=this,r=n.getUrlForHero(t.id,o);return e.jsonp(r).then(function(e){return t["last-updated"]<e.data["last-updated"]?!0:!1})}var d={loadHeroesData:o,HasNewData:u};return d}angular.module("d3dps").service("heroService",e),e.$inject=["$http","$q","urlService"]}(),function(){"use strict";function e(e,t,n,o,r,a){function i(e){return"http://eu.battle.net/d3/en/"+e}function l(e){return"http://media.blizzard.com/d3/icons/items/large/"+e+".png"}function c(){return g}function u(){return h}function s(e){h=!0;for(var t=0;t<m.heroes.length;t++)e.id==m.heroes[t].id&&(m.currentHero=m.heroes[t])}function d(){m.heroes=null,g=!0,null!==v&&void 0!==v&&(m.battleNetTag=v),null!==m.battleNetTag&&void 0!==m.battleNetTag&&(m.battleNetTag=r.getBattleNetTag(m.battleNetTag));var e=r.getUrlForHeroes(m.battleNetTag);t.jsonp(e).then(function(e){a.loadHeroesData(e.data.heroes,m.battleNetTag).then(function(e){m.heroes=e,g=!1})})}function f(){null!=m.heroes&&(m.hasNewData=!1,a.HasNewData(m.heroes,m.battleNetTag).then(function(e){m.hasNewData=e,console.log("von new data result: "+e)}))}function p(){return m.hasNewData}var m=this,g=!1,h=!1,v=o.search().battlenetTag;m.loadProfile=d,m.areHeroesLoading=c,m.isHeroLoading=u,m.loadHero=s,m.newUpdates=p,m.ImageUrl=l,m.TooltipUrl=i,m.dps={},n(f,6e4)}angular.module("d3dps").controller("Home",e),e.$inject=["$scope","$http","$interval","$location","urlService","heroService"]}(),function(){"use strict";function e(e){return{restrict:"A",link:function(t,n,o){t.isLoading=function(){return e.pendingRequests.length>0},t.$watch(t.isLoading,function(e){e?n.show():n.hide()})}}}angular.module("d3dps").directive("loading",["$http",e])}();